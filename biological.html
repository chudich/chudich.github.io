<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nhịp Sinh Học</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600&display=swap');

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 {
            text-align: center;
            color: #1a1a1a;
            font-weight: 600;
            font-size: 2rem;
            margin-bottom: 20px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .home-menu {
            margin-bottom: 20px;
        }
        .home-menu a {
            display: inline-block;
            padding: 10px 20px;
            background: linear-gradient(135deg, #007aff, #00c6ff);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }
        .home-menu a:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 122, 255, 0.4);
        }
        form {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(8px);
            width: 100%;
            max-width: 600px;
        }
        label {
            display: block;
            margin: 10px 0 5px;
            font-weight: 500;
            color: #333;
        }
        input {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        input:focus {
            outline: none;
            border-color: #007aff;
            box-shadow: 0 0 8px rgba(0, 122, 255, 0.3);
        }
        button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #007aff, #00c6ff);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }
        #chartContainer {
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(8px);
            width: 100%;
        }
        #error {
            color: #ff3b30;
            margin-top: 10px;
            font-weight: 500;
        }
        #analysisTable {
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(8px);
            width: 100%;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid rgba(0, 0, 0, 0.1);
            padding: 12px;
            text-align: left;
            transition: background 0.3s ease;
        }
        th {
            background-color: rgba(0, 122, 255, 0.1);
            color: #007aff;
            font-weight: 600;
        }
        td {
            background: rgba(255, 255, 255, 0.8);
        }
        tr:hover td {
            background: rgba(0, 122, 255, 0.05);
        }
        .min-cell {
            color: #ff3b30;
            font-weight: 500;
        }
        .avg-cell {
            color: #8e8e93;
            font-weight: 500;
        }
        .max-cell {
            color: #28a745; /* Darker green for Max */
            font-weight: 500;
        }
        .intersect-dir {
            white-space: pre-line; /* Cho phép xuống dòng */
        }
        .bold-name {
            font-weight: 600;
        }
        .up {
            color: #28a745; /* Darker green for Tăng */
            font-weight: 600;
        }
        .down {
            color: #ff3b30; /* Red for Giảm */
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="home-menu">
        <a href="#">Về Trang Chủ</a>
    </div>
    <h1>Tính Nhịp Sinh Học</h1>
    <form id="biorhythmForm">
        <label for="birthday">Ngày sinh (dd/mm/yyyy):</label>
        <input type="text" id="birthday" placeholder="dd/mm/yyyy" required>

        <label for="birthtime">Giờ sinh (HH:mm):</label>
        <input type="text" id="birthtime" placeholder="HH:mm" required>

        <button type="submit">Tính toán và hiển thị biểu đồ</button>
        <div id="error"></div>
    </form>
    <div id="chartContainer">
        <canvas id="biorhythmChart" style="width: 100%; height: 600px;"></canvas>
    </div>
    <div id="analysisTable"></div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Ngày hiện tại (hardcode theo yêu cầu: September 29, 2025)
        const currentDate = new Date(2025, 8, 29, 0, 0, 0); // Tháng bắt đầu từ 0 trong JS

        // Xử lý form submit
        document.getElementById('biorhythmForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const birthdayInput = document.getElementById('birthday').value.trim();
            const birthtimeInput = document.getElementById('birthtime').value.trim();
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = '';

            // Kiểm tra định dạng ngày sinh dd/mm/yyyy
            const datePattern = /^(\d{2})\/(\d{2})\/(\d{4})$/;
            const matchDate = birthdayInput.match(datePattern);
            if (!matchDate) {
                errorDiv.textContent = 'Ngày sinh không hợp lệ. Vui lòng nhập theo định dạng dd/mm/yyyy.';
                return;
            }

            const day = parseInt(matchDate[1]);
            const month = parseInt(matchDate[2]);
            const year = parseInt(matchDate[3]);

            // Kiểm tra định dạng giờ sinh HH:mm
            const timePattern = /^(\d{2}):(\d{2})$/;
            const matchTime = birthtimeInput.match(timePattern);
            if (!matchTime) {
                errorDiv.textContent = 'Giờ sinh không hợp lệ. Vui lòng nhập theo định dạng HH:mm.';
                return;
            }

            const hour = parseInt(matchTime[1]);
            const minute = parseInt(matchTime[2]);
            if (hour < 0 || hour > 23 || minute < 0 || minute > 59) {
                errorDiv.textContent = 'Giờ hoặc phút không hợp lệ.';
                return;
            }

            // Kiểm tra ngày hợp lệ
            const birthDate = new Date(year, month - 1, day, hour, minute, 0);
            if (isNaN(birthDate.getTime()) || birthDate.getDate() !== day || birthDate.getMonth() !== month - 1) {
                errorDiv.textContent = 'Ngày sinh không tồn tại. Vui lòng kiểm tra lại.';
                return;
            }

            // Tạo mảng 15 ngày từ ngày hiện tại
            const days = Array.from({length: 15}, (_, i) => i);
            const dates = days.map(d => {
                const date = new Date(currentDate);
                date.setDate(date.getDate() + d);
                return date;
            });

            // Tính số ngày sống cho từng ngày (chính xác đến milliseconds, chia cho 86400000 để lấy ngày)
            const daysLived = dates.map(d => (d - birthDate) / (1000 * 60 * 60 * 24));

            // Tính giá trị sin (nhân 100 để thành %)
            const physical = daysLived.map(dl => Math.sin(2 * Math.PI * dl / 23) * 100); // Năng lượng thể chất
            const emotional = daysLived.map(dl => Math.sin(2 * Math.PI * dl / 28) * 100); // Cảm xúc
            const intellectual = daysLived.map(dl => Math.sin(2 * Math.PI * dl / 33) * 100); // Trí tuệ
            const love = daysLived.map(dl => Math.sin(2 * Math.PI * dl / 38) * 100); // Tình yêu

            // Chuẩn bị labels cho biểu đồ (ngày/tháng/năm)
            const labels = dates.map(d => d.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' }));

            // Vẽ biểu đồ sử dụng Chart.js
            const ctx = document.getElementById('biorhythmChart').getContext('2d');
            if (window.myChart) window.myChart.destroy(); // Xóa biểu đồ cũ nếu có
            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Năng lượng thể chất', data: physical, borderColor: 'red', fill: false, tension: 0.1 },
                        { label: 'Cảm xúc', data: emotional, borderColor: 'blue', fill: false, tension: 0.1 },
                        { label: 'Trí tuệ', data: intellectual, borderColor: 'green', fill: false, tension: 0.1 },
                        { label: 'Tình yêu', data: love, borderColor: 'purple', fill: false, tension: 0.1 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: -100,
                            max: 100,
                            title: { display: true, text: 'Mức độ (%)' }
                        },
                        x: {
                            title: { display: true, text: 'Ngày (0: Hôm nay)' },
                            ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 }
                        }
                    },
                    plugins: {
                        legend: { position: 'top' }
                    }
                }
            });

            // Phân tích Min, Max, Trung bình
            const states = {
                physical: { name: 'Năng lượng thể chất', data: physical, color: 'red' },
                emotional: { name: 'Cảm xúc', data: emotional, color: 'blue' },
                intellectual: { name: 'Trí tuệ', data: intellectual, color: 'green' },
                love: { name: 'Tình yêu', data: love, color: 'purple' }
            };

            let tableHtml = '<h3>Phân Tích Trạng Thái Min, Trung Bình, Max</h3><table><tr><th>Trạng thái</th><th class="min-cell">Min (thấp nhất)</th><th class="avg-cell">Trung bình (gần 0)</th><th class="max-cell">Max (cao nhất)</th></tr>';
            for (const key in states) {
                const state = states[key];
                const minDays = [];
                const avgDays = [];
                const maxDays = [];
                let minVal = Math.min(...state.data);
                let maxVal = Math.max(...state.data);
                state.data.forEach((val, idx) => {
                    if (Math.abs(val - minVal) < 0.01) minDays.push(labels[idx]);
                    if (Math.abs(val) < 10) avgDays.push(labels[idx]);
                    if (Math.abs(val - maxVal) < 0.01) maxDays.push(labels[idx]);
                });
                tableHtml += `<tr><td class="bold-name">${state.name}</td><td class="min-cell">${minDays.join(', ') || 'Không có'}</td><td class="avg-cell">${avgDays.join(', ') || 'Không có'}</td><td class="max-cell">${maxDays.join(', ') || 'Không có'}</td></tr>`;
            }
            tableHtml += '</table>';

            // Phân tích giao điểm giữa 2 đường
            tableHtml += '<h3>Giao Điểm Giữa 2 Trạng Thái</h3><table><tr><th>Cặp trạng thái</th><th>Ngày giao điểm (khoảng)</th><th>Trạng thái tại giao điểm</th><th>Hướng (tăng/giảm)</th></tr>';
            const pairs = [
                { a: 'physical', b: 'emotional', name: 'Năng lượng thể chất & Cảm xúc' },
                { a: 'physical', b: 'intellectual', name: 'Năng lượng thể chất & Trí tuệ' },
                { a: 'physical', b: 'love', name: 'Năng lượng thể chất & Tình yêu' },
                { a: 'emotional', b: 'intellectual', name: 'Cảm xúc & Trí tuệ' },
                { a: 'emotional', b: 'love', name: 'Cảm xúc & Tình yêu' },
                { a: 'intellectual', b: 'love', name: 'Trí tuệ & Tình yêu' }
            ];
            pairs.forEach(pair => {
                const intersectInfo = [];
                for (let i = 0; i < days.length - 1; i++) {
                    const diff1 = states[pair.a].data[i] - states[pair.b].data[i];
                    const diff2 = states[pair.a].data[i + 1] - states[pair.b].data[i + 1];
                    if (diff1 * diff2 < 0) {
                        const approxVal = (states[pair.a].data[i] + states[pair.b].data[i]) / 2;
                        const dirA = states[pair.a].data[i + 1] > states[pair.a].data[i] ? 'Tăng' : 'Giảm';
                        const dirB = states[pair.b].data[i + 1] > states[pair.b].data[i] ? 'Tăng' : 'Giảm';
                        intersectInfo.push({
                            day: `Giữa ${labels[i]} và ${labels[i + 1]}`,
                            value: approxVal.toFixed(2),
                            dir: `${states[pair.a].name}: <span class="${dirA === 'Tăng' ? 'up' : 'down'}">${dirA}</span>\n${states[pair.b].name}: <span class="${dirB === 'Tăng' ? 'up' : 'down'}">${dirB}</span>`
                        });
                    }
                }
                let row = `<tr><td class="bold-name">${pair.name}</td><td>`;
                let valueCell = '<td>';
                let dirCell = '<td class="intersect-dir">';
                if (intersectInfo.length > 0) {
                    intersectInfo.forEach(info => {
                        row += `${info.day}<br>`;
                        valueCell += `${info.value}%<br>`;
                        dirCell += `${info.dir}<br><br>`;
                    });
                } else {
                    row += 'Không có';
                    valueCell += 'N/A';
                    dirCell += 'N/A';
                }
                row += '</td>' + valueCell + '</td>' + dirCell + '</td></tr>';
                tableHtml += row;
            });
            tableHtml += '</table>';

            // Phân tích giao điểm giữa 3 đường và 4 đường (trạng thái gần bằng nhau, ngưỡng 5%)
            tableHtml += '<h3>Giao Điểm Giữa 3 hoặc 4 Trạng Thái</h3><table><tr><th>Số trạng thái</th><th>Ngày</th><th>Trạng thái tại giao điểm</th><th>Hướng (tăng/giảm)</th></tr>';
            const triples = [
                { keys: ['physical', 'emotional', 'intellectual'], name: 'Năng lượng thể chất, Cảm xúc, Trí tuệ' },
                { keys: ['physical', 'emotional', 'love'], name: 'Năng lượng thể chất, Cảm xúc, Tình yêu' },
                { keys: ['physical', 'intellectual', 'love'], name: 'Năng lượng thể chất, Trí tuệ, Tình yêu' },
                { keys: ['emotional', 'intellectual', 'love'], name: 'Cảm xúc, Trí tuệ, Tình yêu' }
            ];
            const quadruple = { keys: ['physical', 'emotional', 'intellectual', 'love'], name: 'Tất cả 4 trạng thái' };

            // Hàm kiểm tra giao điểm cho nhóm
            function findGroupIntersects(group) {
                const intersectDays = [];
                for (let i = 0; i < days.length; i++) {
                    const values = group.keys.map(k => states[k].data[i]);
                    if (Math.max(...values) - Math.min(...values) < 5) {
                        const avgVal = values.reduce((a, b) => a + b, 0) / values.length;
                        let dirs = '';
                        group.keys.forEach(k => {
                            let dir = 'N/A';
                            if (i < days.length - 1) {
                                dir = states[k].data[i + 1] > states[k].data[i] ? 'Tăng' : 'Giảm';
                            }
                            dirs += `${states[k].name}: <span class="${dir === 'Tăng' ? 'up' : 'down'}">${dir}</span>\n`;
                        });
                        intersectDays.push({ day: labels[i], value: avgVal.toFixed(2), dirs: dirs.trim() });
                    }
                }
                return intersectDays;
            }

            // Cho 3 đường
            triples.forEach(triple => {
                const info = findGroupIntersects(triple);
                let row = `<tr><td class="bold-name">3: ${triple.name}</td><td>`;
                let valueCell = '<td>';
                let dirCell = '<td class="intersect-dir">';
                if (info.length > 0) {
                    info.forEach(d => {
                        row += `${d.day}<br>`;
                        valueCell += `${d.value}%<br>`;
                        dirCell += `${d.dirs}<br><br>`;
                    });
                } else {
                    row += 'Không có';
                    valueCell += 'N/A';
                    dirCell += 'N/A';
                }
                row += '</td>' + valueCell + '</td>' + dirCell + '</td></tr>';
                tableHtml += row;
            });

            // Cho 4 đường
            const quadInfo = findGroupIntersects(quadruple);
            let quadRow = `<tr><td class="bold-name">4: ${quadruple.name}</td><td>`;
            let quadValue = '<td>';
            let quadDir = '<td class="intersect-dir">';
            if (quadInfo.length > 0) {
                quadInfo.forEach(info => {
                    quadRow += `${info.day}<br>`;
                    quadValue += `${info.value}%<br>`;
                    quadDir += `${info.dirs}<br><br>`;
                });
            } else {
                quadRow += 'Không có';
                quadValue += 'N/A';
                quadDir += 'N/A';
            }
            quadRow += '</td>' + quadValue + '</td>' + quadDir + '</td></tr>';
            tableHtml += quadRow;
            tableHtml += '</table>';

            document.getElementById('analysisTable').innerHTML = tableHtml;
        });
    </script>
</body>
</html>