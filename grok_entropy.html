<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grok's AI-Entropy Casting - L·∫•y Qu·∫ª D·ªãch</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Vietnamese:wght@400;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Serif Vietnamese', serif;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #fff3e0, #ffd6cc);
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
            padding-top: 80px; /* Space for fixed header */
        }

        /* Header */
        header {
            background: linear-gradient(45deg, #d32f2f, #b71c1c); /* Match button gradient */
            padding: 15px 0;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(8px);
        }

        .container {
            max-width: 450px;
            margin: 0 auto;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* Menu */
        .main-menu ul {
            list-style: none;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }

        .main-menu ul li {
            margin: 0 10px;
            opacity: 0;
            animation: fadeInMenu 0.5s ease forwards;
            animation-delay: calc(0.1s * var(--i));
        }

        .main-menu ul li:nth-child(1) { --i: 1; }

        @keyframes fadeInMenu {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .main-menu ul li a {
            display: block;
            padding: 10px 20px;
            background: linear-gradient(135deg, #007AFF, #00C6FF); /* iOS blue */
            color: #FFFFFF;
            text-decoration: none;
            font-size: 1.2rem; /* Medium text size */
            font-weight: 700; /* Bold */
            border-radius: 10px;
            border: 2px solid #FFFFFF;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(4px);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .main-menu ul li a:hover {
            background: linear-gradient(135deg, #005BB5, #0096D6);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .menu-toggle {
            display: none;
            flex-direction: column;
            cursor: pointer;
            position: absolute;
            top: 15px;
            right: 20px;
        }

        .menu-toggle span {
            width: 25px;
            height: 3px;
            background: #FFFFFF;
            margin: 4px 0;
            transition: all 0.3s;
        }

        .menu-toggle.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .menu-toggle.active span:nth-child(2) {
            opacity: 0;
        }

        .menu-toggle.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -7px);
        }

        .form-container {
            display: flex;
            justify-content: space-between;
        }

        .main-form {
            width: 70%;
        }

        .side-menu {
            width: 28%;
            padding-left: 10px;
        }

        h2 {
            color: #8b0000;
            font-size: 2rem;
            margin: 20px 0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            font-size: 16px;
            border: 2px solid #8b0000;
            border-radius: 30px;
            outline: none;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input:focus, textarea:focus, select:focus {
            border-color: #ff4040;
            box-shadow: 0 0 10px rgba(255, 64, 64, 0.3);
        }

        button {
            padding: 12px 30px;
            background: linear-gradient(45deg, #d32f2f, #b71c1c);
            color: white;
            border: none;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-size: 16px;
            margin: 5px 0;
            border-radius: 30px;
            transition: background 0.3s, transform 0.2s;
        }

        button:hover {
            background: linear-gradient(45deg, #b71c1c, #9a0007);
            transform: scale(1.05);
        }

        #ket_qua {
            margin-top: 20px;
            text-align: left;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.8);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            touch-action: manipulation;
        }

        .hao {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .line-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .yang-line {
            width: 100px;
            height: 10px;
            background: #ff3333;
            border-radius: 3px;
        }

        .yin-line {
            display: flex;
            gap: 10px;
        }

        .yin-line div {
            width: 45px;
            height: 10px;
            background: #808080;
            border-radius: 3px;
        }

        .hao-status {
            font-size: 14px;
            margin-left: 10px;
            color: #ff4040;
        }

        .dong-text {
            font-weight: bold;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        #ten_que {
            margin-top: 10px;
            font-size: 18px;
            font-weight: bold;
            color: #8b0000;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        #changed-hexagram {
            margin-top: 20px;
            text-align: left;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.8);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        #changed-hexagram-name {
            font-size: 18px;
            font-weight: bold;
            color: #8b0000;
            margin-bottom: 10px;
        }

        .download-time {
            font-weight: bold;
            color: red;
            margin-top: 10px;
        }

        .form-label {
            font-weight: bold;
            color: #8b0000;
            text-align: left;
            margin-bottom: 5px;
            display: block;
        }

        .color-preview {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 10px;
            vertical-align: middle;
        }

        /* Responsive Design */
        @media (max-width: 600px) {
            .form-container {
                flex-direction: column;
            }
            .main-form, .side-menu {
                width: 100%;
            }
            .side-menu {
                padding-left: 0;
                margin-top: 10px;
            }

            .main-menu {
                display: none;
            }

            .main-menu.active {
                display: block;
                position: absolute;
                top: 60px;
                left: 0;
                width: 100%;
                background: linear-gradient(45deg, #d32f2f, #b71c1c);
                backdrop-filter: blur(8px);
                padding: 10px 0;
            }

            .main-menu ul {
                flex-direction: column;
                align-items: center;
            }

            .main-menu ul li {
                margin: 5px 0;
            }

            .main-menu ul li a {
                font-size: 1.1rem; /* Medium text size for mobile */
                padding: 8px 16px;
            }

            .menu-toggle {
                display: flex;
                justify-content: flex-end;
            }
        }

        @media (max-width: 400px) {
            .form-container {
                flex-direction: column;
            }
            .main-form, .side-menu {
                width: 100%;
            }
            .side-menu {
                padding-left: 0;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <nav class="main-menu">
                <ul>
                    <li><a href="https://chudich.github.io/IChing.html">V·ªÅ Trang Ch·ªß</a></li>
                </ul>
            </nav>
            <div class="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
    </header>

    <div class="container">
        <div>
            <h2>Grok's AI-Entropy Casting</h2>
            <p>Nh·∫≠p th√¥ng tin ƒë·ªÉ t√≠nh entropy v√† l·∫•y qu·∫ª. C√°c tr∆∞·ªùng kh√¥ng b·∫Øt bu·ªôc c√≥ th·ªÉ b·ªè tr·ªëng.</p>
            <div class="form-container">
                <div class="main-form">
                    <span class="form-label">H·ªç t√™n ƒë·∫ßy ƒë·ªß</span>
                    <input type="text" id="ho_ten" placeholder="H·ªç t√™n ƒë·∫ßy ƒë·ªß">
                    <span class="form-label">Tu·ªïi cha (d∆∞∆°ng/√¢m l·ªãch)</span>
                    <input type="text" id="tuoi_cha" placeholder="Tu·ªïi cha (d∆∞∆°ng/√¢m l·ªãch)">
                    <span class="form-label">Tu·ªïi m·∫π (d∆∞∆°ng/√¢m l·ªãch)</span>
                    <input type="text" id="tuoi_me" placeholder="Tu·ªïi m·∫π (d∆∞∆°ng/√¢m l·ªãch)">
                    <span class="form-label">Ng√†y - th√°ng - nƒÉm sinh c·ªßa ng∆∞·ªùi xin qu·∫ª</span>
                    <input type="date" id="ngay_sinh" placeholder="Ng√†y - th√°ng - nƒÉm sinh c·ªßa ng∆∞·ªùi xin qu·∫ª">
                    <span class="form-label">Gi·ªù sinh c·ªßa ng∆∞·ªùi xin qu·∫ª (t√πy ch·ªçn)</span>
                    <input type="time" id="gio_sinh" placeholder="Gi·ªù sinh c·ªßa ng∆∞·ªùi xin qu·∫ª (t√πy ch·ªçn)">
                    <span class="form-label">Gi·ªõi t√≠nh</span>
                    <select id="gioi_tinh">
                        <option value="">Gi·ªõi t√≠nh</option>
                        <option value="Nam">Nam</option>
                        <option value="N·ªØ">N·ªØ</option>
                    </select>
                    <span class="form-label">T√¨nh tr·∫°ng gia ƒë√¨nh</span>
                    <select id="tinh_trang_gia_dinh">
                        <option value="">T√¨nh tr·∫°ng gia ƒë√¨nh</option>
                        <option value="ƒê·ªôc th√¢n">ƒê·ªôc th√¢n</option>
                        <option value="ƒê√£ k·∫øt h√¥n">ƒê√£ k·∫øt h√¥n</option>
                        <option value="Ly th√¢n">Ly th√¢n</option>
                        <option value="Ly d·ªã">Ly d·ªã</option>
                        <option value="ƒêang h·∫πn h√≤">ƒêang h·∫πn h√≤</option>
                    </select>
                    <span class="form-label">T√¥n gi√°o</span>
                    <select id="ton_giao">
                        <option value="">T√¥n gi√°o</option>
                        <option value="Kh√¥ng">Kh√¥ng</option>
                        <option value="Ph·∫≠t">Ph·∫≠t</option>
                        <option value="Cao ƒê√†i">Cao ƒê√†i</option>
                        <option value="Ho√† H·∫£o">Ho√† H·∫£o</option>
                        <option value="Thi√™n Ch√∫a">Thi√™n Ch√∫a</option>
                        <option value="Tin L√†nh">Tin L√†nh</option>
                        <option value="H·ªìi Gi√°o">H·ªìi Gi√°o</option>
                        <option value="Kh√°c">Kh√°c</option>
                    </select>
                    <span class="form-label">M·ª•c ƒë√≠ch</span>
                    <select id="muc_dich">
                        <option value="">M·ª•c ƒë√≠ch</option>
                        <option value="Gi·∫£i tr√≠">Gi·∫£i tr√≠</option>
                        <option value="T√≤ m√≤">T√≤ m√≤</option>
                        <option value="Th√†nh t√¢m xem">Th√†nh t√¢m xem</option>
                    </select>
                    <span class="form-label">N·ªôi dung mu·ªën xem</span>
                    <input type="text" id="su_viec" placeholder="Nh·∫≠p s·ª± vi·ªác c·∫ßn xem">
                    <span class="form-label">D√£y s·ªë ng·∫´u nhi√™n b·∫°n nghƒ© ƒë·∫øn / y√™u th√≠ch</span>
                    <input type="text" id="day_so" placeholder="V√≠ d·ª•: 3 7 12">
                    <span class="form-label">M√†u s·∫Øc b·∫°n nghƒ© ƒë·∫øn / y√™u th√≠ch</span>
                    <select id="mau_sac" onchange="updateColorPreview()">
                        <option value="">Ch·ªçn m√†u</option>
                        <option value="#FF0000" style="background-color: #FF0000;">ƒê·ªè</option>
                        <option value="#00FF00" style="background-color: #00FF00;">Xanh l√°</option>
                        <option value="#0000FF" style="background-color: #0000FF;">Xanh d∆∞∆°ng</option>
                        <option value="#FFFF00" style="background-color: #FFFF00;">V√†ng</option>
                        <option value="#FF00FF" style="background-color: #FF00FF;">T√≠m</option>
                        <option value="#000000" style="background-color: #000000; color: white;">ƒêen</option>
                        <option value="#FFFFFF" style="background-color: #FFFFFF;">Tr·∫Øng</option>
                    </select>
                    <div id="color-preview" class="color-preview" style="background-color: #ffffff;"></div>
                    <input type="checkbox" id="useGPS"> S·ª≠ d·ª•ng GPS ƒë·ªÉ b·ªï sung d·ªØ li·ªáu v·ªã tr√≠ (n·∫øu browser h·ªó tr·ª£ v√† b·∫°n cho ph√©p)<br>
                    <button onclick="castHexagram()">L·∫•y Qu·∫ª</button>
                </div>
                <div class="side-menu">
                    <button onclick="resetForm()">Reset</button>
                </div>
            </div>
            <div id="ten_que"></div>
        </div>
        <div id="ket_qua"></div>
        <div id="changed-hexagram" style="display: none;">
            <div id="changed-hexagram-name"></div>
            <div id="changed-hexagram-lines"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script>
        // Toggle menu
        const menuToggle = document.querySelector('.menu-toggle');
        const mainMenu = document.querySelector('.main-menu');
        menuToggle.addEventListener('click', () => {
            mainMenu.classList.toggle('active');
            menuToggle.classList.toggle('active');
        });

        const queDon = {
            '111': 'Ki·ªÅn', '011': 'ƒêo√†i', '101': 'Ly', '001': 'Ch·∫•n',
            '110': 'T·ªën', '010': 'Kh·∫£m', '100': 'C·∫•n', '000': 'Kh√¥n'
        };
        const queKep = {
            '111111': 'Thu·∫ßn Ki·ªÅn', '111110': 'Thi√™n Phong C·∫•u', '111100': 'Thi√™n S∆°n ƒê·ªôn', '111000': 'Thi√™n ƒê·ªãa Bƒ©',
            '110000': 'Phong ƒê·ªãa Qu√°n', '100000': 'S∆°n ƒê·ªãa B√°c', '101000': 'Ho·∫£ ƒê·ªãa T·∫•n', '101111': 'Ho·∫£ Thi√™n ƒê·∫°i H·ªØu',
            '011011': 'Thu·∫ßn ƒêo√†i', '011010': 'Tr·∫°ch Th·ªßy Kh·ªën', '011000': 'Tr·∫°ch ƒê·ªãa T·ª•y', '011100': 'Tr·∫°ch S∆°n H√†m',
            '010100': 'Th·ªßy S∆°n Ki·ªÉn', '000100': 'ƒê·ªãa S∆°n Khi√™m', '001100': 'L√¥i S∆°n Ti·ªÉu Qu√°', '001011': 'L√¥i Tr·∫°ch Quy Mu·ªôi',
            '101101': 'Thu·∫ßn Ly', '101100': 'Ho·∫£ S∆°n L·ªØ', '101110': 'Ho·∫£ Phong ƒê·ªânh', '101010': 'Ho·∫£ Th·ªßy V·ªã T·∫ø',
            '100010': 'S∆°n Th·ªßy M√¥ng', '110010': 'Phong Th·ªßy Ho√°n', '111010': 'Thi√™n Th·ªßy T·ª•ng', '111101': 'Thi√™n Ho·∫£ ƒê·ªìng Nh√¢n',
            '001001': 'Thu·∫ßn Ch·∫•n', '001000': 'L√¥i ƒê·ªãa D·ª±', '001010': 'L√¥i Th·ªßy Gi·∫£i', '001110': 'L√¥i Phong H·∫±ng',
            '000110': 'ƒê·ªãa Phong ThƒÉng', '010110': 'Th·ªßy Phong Tƒ©nh', '011110': 'Tr·∫°ch Phong ƒê·∫°i Qu√°', '011001': 'Tr·∫°ch L√¥i T√πy',
            '110110': 'Thu·∫ßn T·ªën', '110111': 'Phong Thi√™n Ti·ªÉu S√∫c', '110101': 'Phong Ho·∫£ Gia Nh√¢n', '110001': 'Phong L√¥i √çch',
            '111001': 'Thi√™n L√¥i V√¥ V·ªçng', '101001': 'Ho·∫£ L√¥i Ph·ªá H·∫°p', '100001': 'S∆°n L√¥i Di', '100110': 'S∆°n Phong C·ªï',
            '010010': 'Thu·∫ßn Kh·∫£m', '010011': 'Th·ªßy Tr·∫°ch Ti·∫øt', '010001': 'Th·ªßy L√¥i Tru√¢n', '010101': 'Th·ªßy Ho·∫£ K√Ω T·∫ø',
            '011101': 'Tr·∫°ch Ho·∫£ C√°ch', '001101': 'L√¥i Ho·∫£ Phong', '000101': 'ƒê·ªãa Ho·∫£ Minh Di', '000010': 'ƒê·ªãa Th·ªßy S∆∞',
            '100100': 'Thu·∫ßn C·∫•n', '100101': 'S∆°n Ho·∫£ B√≠', '100111': 'S∆°n Thi√™n ƒê·∫°i S√∫c', '100011': 'S∆°n Tr·∫°ch T·ªïn',
            '101011': 'Ho·∫£ Tr·∫°ch Khu√™', '111011': 'Thi√™n Tr·∫°ch L√Ω', '110011': 'Phong Tr·∫°ch Trung Phu', '110100': 'Phong S∆°n Ti·ªám',
            '000000': 'Thu·∫ßn Kh√¥n', '000001': 'ƒê·ªãa L√¥i Ph·ª•c', '000011': 'ƒê·ªãa Tr·∫°ch L√¢m', '000111': 'ƒê·ªãa Thi√™n Th√°i',
            '001111': 'L√¥i Thi√™n ƒê·∫°i Tr√°ng', '011111': 'Tr·∫°ch Thi√™n Qu·∫£i', '010111': 'Th·ªßy Thi√™n Nhu', '010000': 'Th·ªßy ƒê·ªãa T·ª∑'
        };

        let longPressTimeout;

        function updateColorPreview() {
            const mauSac = document.getElementById('mau_sac').value;
            const colorPreview = document.getElementById('color-preview');
            colorPreview.style.backgroundColor = mauSac || '#ffffff';
        }

        function resetForm() {
            // X√≥a k·∫øt qu·∫£ hi·ªán t·∫°i
            document.getElementById('ket_qua').innerHTML = '';
            document.getElementById('ten_que').innerHTML = '';
            document.getElementById('changed-hexagram').style.display = 'none';

            // L·∫•y qu·∫ª m·ªõi d·ª±a tr√™n d·ªØ li·ªáu hi·ªán t·∫°i
            castHexagram();
        }

        async function castHexagram() {
            const suViec = document.getElementById('su_viec').value;
            if (!suViec) {
                alert('Vui l√≤ng nh·∫≠p s·ª± vi·ªác c·∫ßn xem!');
                return;
            }
            const hoTen = document.getElementById('ho_ten').value || '';
            const tuoiCha = document.getElementById('tuoi_cha').value || '';
            const tuoiMe = document.getElementById('tuoi_me').value || '';
            const ngaySinh = document.getElementById('ngay_sinh').value || '';
            const gioSinh = document.getElementById('gio_sinh').value || '';
            const gioiTinh = document.getElementById('gioi_tinh').value || '';
            const tinhTrangGiaDinh = document.getElementById('tinh_trang_gia_dinh').value || '';
            const tonGiao = document.getElementById('ton_giao').value || '';
            const mucDich = document.getElementById('muc_dich').value || '';
            const daySo = document.getElementById('day_so').value || '';
            const mauSac = document.getElementById('mau_sac').value || '';
            const currentTime = new Date().toLocaleString('vi-VN', { hour: '2-digit', minute: '2-digit', hour12: false }) + 
                               ' ; ' + 
                               new Date().toLocaleString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/\//g, '.');
            let entropyInput = suViec + ' | HoTen: ' + hoTen + ' | TuoiCha: ' + tuoiCha + ' | TuoiMe: ' + tuoiMe + 
                               ' | NgaySinh: ' + ngaySinh + ' | GioSinh: ' + gioSinh + ' | GioiTinh: ' + gioiTinh + 
                               ' | TinhTrangGiaDinh: ' + tinhTrangGiaDinh + ' | TonGiao: ' + tonGiao + 
                               ' | MucDich: ' + mucDich + ' | DaySo: ' + daySo + ' | MauSac: ' + mauSac + 
                               ' | Time: ' + currentTime;

            let skippedFields = [];
            if (!hoTen) skippedFields.push('H·ªç t√™n');
            if (!tuoiCha) skippedFields.push('Tu·ªïi cha');
            if (!tuoiMe) skippedFields.push('Tu·ªïi m·∫π');
            if (!ngaySinh) skippedFields.push('Ng√†y - th√°ng - nƒÉm sinh');
            if (!gioSinh) skippedFields.push('Gi·ªù sinh');
            if (!gioiTinh) skippedFields.push('Gi·ªõi t√≠nh');
            if (!tinhTrangGiaDinh) skippedFields.push('T√¨nh tr·∫°ng gia ƒë√¨nh');
            if (!tonGiao) skippedFields.push('T√¥n gi√°o');
            if (!mucDich) skippedFields.push('M·ª•c ƒë√≠ch');
            if (skippedFields.length > 0) {
                alert('C·∫£nh b√°o: Form b·ªã b·ªè qua (' + skippedFields.join(', ') + ') s·∫Ω thi·∫øu Entropy, qu·∫ª l·∫•y ƒë∆∞·ª£c c√≥ th·ªÉ kh√¥ng th·ªÉ hi·ªán h·∫øt th√¥ng tin.');
            }

            if (document.getElementById('useGPS').checked) {
                try {
                    const position = await getLocation();
                    entropyInput += ' | Lat: ' + position.coords.latitude + ' | Lon: ' + position.coords.longitude;
                } catch (error) {
                    console.log('GPS Error:', error);
                    alert('Kh√¥ng th·ªÉ l·∫•y GPS. C√≥ th·ªÉ b·∫°n c·∫ßn c·∫•p quy·ªÅn truy c·∫≠p v·ªã tr√≠ trong c√†i ƒë·∫∑t tr√¨nh duy·ªát/thi·∫øt b·ªã. Ti·∫øp t·ª•c m√† kh√¥ng c√≥ v·ªã tr√≠.');
                }
            }

            const hashBuffer = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(entropyInput));
            const hashArray = Array.from(new Uint8Array(hashBuffer));

            let lines = [];
            let dongHao = [];
            for (let i = 0; i < 6; i++) {
                let coinSum = 0;
                for (let j = 0; j < 3; j++) {
                    const byte = hashArray[(i * 3 + j) % hashArray.length];
                    coinSum += (byte % 2 === 0 ? 2 : 3);
                }
                const haoType = (coinSum % 2 === 1) ? 'duong' : 'am';
                const isDong = (coinSum === 6 || coinSum === 9);
                lines.push({ type: haoType, isDong: isDong });
                if (isDong) dongHao.push(6 - i);
            }

            const ketQuaDiv = document.getElementById('ket_qua');
            const tenQueDiv = document.getElementById('ten_que');
            const changedHexagramDiv = document.getElementById('changed-hexagram');

            ketQuaDiv.innerHTML = `<p>S·ª± vi·ªác: ${suViec || 'Kh√¥ng nh·∫≠p'}</p>`;
            tenQueDiv.innerHTML = '';
            changedHexagramDiv.style.display = 'none';

            for (let haoNum = 6; haoNum >= 1; haoNum--) {
                const index = 6 - haoNum;
                const line = lines[index];
                let haoDisplay;
                if (line.type === 'duong') {
                    haoDisplay = '<div class="line-container"><div class="yang-line"></div><span class="hao-status">' + 
                                (line.isDong ? '(d∆∞∆°ng, <span class="dong-text">ƒë·ªông</span>)' : '(d∆∞∆°ng)') + '</span></div>';
                } else {
                    haoDisplay = '<div class="line-container"><div class="yin-line"><div></div><div></div></div><span class="hao-status">' + 
                                (line.isDong ? '(√¢m, <span class="dong-text">ƒë·ªông</span>)' : '(√¢m)') + '</span></div>';
                }
                const haoDiv = document.createElement('div');
                haoDiv.className = 'hao';
                haoDiv.innerHTML = `H√†o ${haoNum}: ${haoDisplay}`;
                ketQuaDiv.appendChild(haoDiv);
            }

            const binaryLines = lines.map(line => line.type === 'duong' ? '1' : '0');
            const thuongQuai = binaryLines.slice(0, 3).join('');
            const haQuai = binaryLines.slice(3, 6).join('');
            const queKepCode = thuongQuai + haQuai;
            const tenThuongQuai = queDon[thuongQuai] || 'Kh√¥ng x√°c ƒë·ªãnh';
            const tenHaQuai = queDon[haQuai] || 'Kh√¥ng x√°c ƒë·ªãnh';
            const tenQueKep = queKep[queKepCode] || 'Kh√¥ng x√°c ƒë·ªãnh';

            let displayText = `Qu·∫ª ch·ªß: ${tenQueKep} (Th∆∞·ª£ng: ${tenThuongQuai}, H·∫°: ${tenHaQuai})`;
            if (dongHao.length > 0) {
                displayText += `, ƒë·ªông h√†o ${dongHao.sort((a, b) => a - b).join(', ')}`;
            } else {
                displayText += ', kh√¥ng c√≥ h√†o ƒë·ªông';
            }
            tenQueDiv.innerHTML = displayText;

            if (dongHao.length > 0) {
                const changedBinaryLines = binaryLines.slice();
                dongHao.forEach(haoNum => {
                    const index = 6 - haoNum;
                    changedBinaryLines[index] = changedBinaryLines[index] === '1' ? '0' : '1';
                });
                const changedThuongQuai = changedBinaryLines.slice(0, 3).join('');
                const changedHaQuai = changedBinaryLines.slice(3, 6).join('');
                const changedQueKepCode = changedThuongQuai + changedHaQuai;
                const changedTenQueKep = queKep[changedQueKepCode] || 'Kh√¥ng x√°c ƒë·ªãnh';
                const changedTenThuongQuai = queDon[changedThuongQuai] || 'Kh√¥ng x√°c ƒë·ªãnh';
                const changedTenHaQuai = queDon[changedHaQuai] || 'Kh√¥ng x√°c ƒë·ªãnh';

                const changedHexagramName = document.getElementById('changed-hexagram-name');
                const changedHexagramLines = document.getElementById('changed-hexagram-lines');

                changedHexagramName.textContent = `Qu·∫ª bi·∫øn: ${changedTenQueKep} (Th∆∞·ª£ng: ${changedTenThuongQuai}, H·∫°: ${changedTenHaQuai})`;
                changedHexagramLines.innerHTML = '';

                for (let haoNum = 6; haoNum >= 1; haoNum--) {
                    const index = 6 - haoNum;
                    const bit = changedBinaryLines[index];
                    let lineHTML = `H√†o ${haoNum}: `;
                    if (bit === '1') {
                        lineHTML += '<div class="line-container"><div class="yang-line"></div><span class="hao-status">(d∆∞∆°ng)</span></div>';
                    } else {
                        lineHTML += '<div class="line-container"><div class="yin-line"><div></div><div></div></div><span class="hao-status">(√¢m)</span></div>';
                    }
                    const haoDiv = document.createElement('div');
                    haoDiv.className = 'hao';
                    haoDiv.innerHTML = lineHTML;
                    changedHexagramLines.appendChild(haoDiv);
                }
                changedHexagramDiv.style.display = 'block';
            }

            const ketQuaElement = document.getElementById('ket_qua');
            ketQuaElement.onmousedown = ketQuaElement.ontouchstart = function(e) {
                clearTimeout(longPressTimeout);
                longPressTimeout = setTimeout(() => downloadHexagram(), 1000);
            };
            ketQuaElement.onmouseup = ketQuaElement.ontouchend = function() {
                clearTimeout(longPressTimeout);
            };
        }

        function getLocation() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 });
                } else {
                    reject('Geolocation kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£ tr√™n tr√¨nh duy·ªát n√†y.');
                }
            });
        }

        function downloadHexagram() {
            const ketQua = document.getElementById('ket_qua');
            const tenQue = document.getElementById('ten_que').textContent;
            const changedHexagram = document.getElementById('changed-hexagram');
            
            // Get current device time in format HH:mm ; DD.MM.YYYY
            const now = new Date();
            const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')} ; ${now.getDate().toString().padStart(2, '0')}.${(now.getMonth() + 1).toString().padStart(2, '0')}.${now.getFullYear()}`;

            const tmp = document.createElement("div");
            tmp.style.position = "fixed";
            tmp.style.left = "-9999px";
            tmp.style.top = "0";
            tmp.style.background = "#ffffff";
            tmp.style.padding = "12px";
            tmp.style.boxSizing = "border-box";
            tmp.style.fontFamily = "'Noto Serif Vietnamese', serif";

            const timeDiv = document.createElement("div");
            timeDiv.textContent = `Gi·ªù ; Ng√†y - Th√°ng - NƒÉm l·∫•y qu·∫ª: ${currentTime}`;
            timeDiv.className = 'download-time';
            tmp.appendChild(timeDiv);

            const suViecDiv = document.createElement("div");
            suViecDiv.textContent = `N·ªôi dung mu·ªën xem: ${document.getElementById('su_viec').value || 'Kh√¥ng nh·∫≠p'}`;
            suViecDiv.style.marginBottom = "10px";
            tmp.appendChild(suViecDiv);

            const tenQueDiv = document.createElement("div");
            tenQueDiv.textContent = tenQue;
            tenQueDiv.style.marginBottom = "10px";
            tmp.appendChild(tenQueDiv);

            tmp.appendChild(ketQua.cloneNode(true));

            if (changedHexagram.style.display !== 'none') {
                tmp.appendChild(changedHexagram.cloneNode(true));
            }

            document.body.appendChild(tmp);

            html2canvas(tmp, {
                useCORS: true,
                scale: window.devicePixelRatio || 2,
                backgroundColor: "#ffffff"
            }).then(canvas => {
                if (typeof canvas.toBlob === "function" && "download" in document.createElement("a")) {
                    canvas.toBlob(function(blob) {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement("a");
                        a.href = url;
                        a.download = "que_kinh_dich.png";
                        document.body.appendChild(a);
                        a.click();
                        setTimeout(() => {
                            URL.revokeObjectURL(url);
                            if (a.parentNode) a.parentNode.removeChild(a);
                            if (tmp.parentNode) tmp.parentNode.removeChild(tmp);
                        }, 150);
                    }, "image/png");
                } else {
                    const dataUrl = canvas.toDataURL("image/png");
                    const img = new Image();
                    img.src = dataUrl;
                    img.style.maxWidth = "100%";
                    img.style.display = "block";
                    img.style.margin = "12px auto";
                    document.body.appendChild(img);
                    alert("üëâ Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ t·∫£i tr·ª±c ti·∫øp.\nNh·∫•n gi·ªØ v√†o ·∫£nh ƒë·ªÉ l∆∞u v·ªÅ m√°y.");
                    if (tmp.parentNode) tmp.parentNode.removeChild(tmp);
                }
            }).catch(err => {
                if (tmp.parentNode) tmp.parentNode.removeChild(tmp);
                console.error("html2canvas error:", err);
                alert("Ch·ª•p ·∫£nh th·∫•t b·∫°i ‚Äî ki·ªÉm tra console.");
            });
        }
    </script>
</body>
</html>
